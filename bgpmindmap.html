<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.14.3/dist/style.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@6.7.0"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.14.3"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.14.3/dist/index.umd.min.js"></script><script>(r => {
                setTimeout(r);
              })(() => {
  const {
    markmap,
    mm
  } = window;
  const toolbar = new markmap.Toolbar();
  toolbar.attach(mm);
  const el = toolbar.render();
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, root, jsonOptions) => {
        const markmap = getMarkmap();
        window.mm = markmap.Markmap.create('svg#mindmap', (getOptions || markmap.deriveOptions)(jsonOptions), root);
      })(() => window.markmap,null,{"type":"heading","depth":0,"payload":{"lines":[1,2]},"content":"BPG","children":[{"type":"heading","depth":1,"payload":{"lines":[2,3]},"content":"Définitions","children":[{"type":"list_item","depth":2,"payload":{"lines":[4,5]},"content":"Un &quot;Autonomous System&quot; est un ensemble de réseaux gérés par une seule entité. Par exemple &quot;RENATER&quot; qui fédère les réseaux des universités françaises."},{"type":"list_item","depth":2,"payload":{"lines":[5,6]},"content":"Un ISP est une entreprise dont le métier est de connecter d'autres entreprises à l'internet.","children":[{"type":"list_item","depth":3,"payload":{"lines":[7,8]},"content":"Les &quot;ISP&quot; de tiers 1 structurent l'internet."},{"type":"list_item","depth":3,"payload":{"lines":[8,9]},"content":"Les &quot;tiers 2&quot; vendent et achètent du transit."},{"type":"list_item","depth":3,"payload":{"lines":[9,10]},"content":"Les &quot;tiers 3&quot; ne fournissent pas de transit. Ils peuvent être &quot;multi-homés&quot;(deux chemins ou plus vers l'internet) afin d'assurer la haute disponibilité des accès et avoir les chemins les plus rapides vers une ressource prisée comme un &quot;GAFAM&quot;."}]},{"type":"list_item","depth":2,"payload":{"lines":[11,12]},"content":"Les points d'échanges sont des lieux physiques où s'interconnectent les &quot;ISP&quot; afin de faciliter les échanges de données (France XI par exemple)."},{"type":"list_item","depth":2,"payload":{"lines":[12,13]},"content":"Un &quot;Point Of Presence&quot; (&quot;POP&quot;) est un lieu physique permettant l'échange de données pour l'internet avec des entités locales."}]},{"type":"heading","depth":1,"payload":{"lines":[14,15]},"content":"Relations entre AS","children":[{"type":"list_item","depth":2,"payload":{"lines":[16,17]},"content":"Le &quot;transit&quot; est le service vendu par un &quot;ISP&quot; (Internet Service Provider) pour donner accès à Internet."},{"type":"list_item","depth":2,"payload":{"lines":[17,18]},"content":"Un &quot;peer&quot; est un routeur d'un autre AS avec lequel on établit une relation de &quot;peering&quot;."},{"type":"list_item","depth":2,"payload":{"lines":[18,19]},"content":"Le &quot;peering&quot; est l’échange réciproque de flux souvent dans un but économique (voir <a href=\"https://www.peeringdb.com/net/433\">https://www.peeringdb.com/net/433</a> comme exemple).","children":[{"type":"list_item","depth":3,"payload":{"lines":[19,20]},"content":"Un &quot;peering&quot; n'est pas transitif : ce n'est pas parce que A à un &quot;peer&quot; avec B et avec C que C a un &quot;peer&quot; avec B."},{"type":"list_item","depth":3,"payload":{"lines":[20,21]},"content":"Un &quot;peering&quot; ne donne pas accès à tous les réseaux de l'&quot;AS&quot; auquel on est connecté."}]}]},{"type":"heading","depth":1,"payload":{"lines":[22,23]},"content":"Caractéristiques de BGP","children":[{"type":"list_item","depth":2,"payload":{"lines":[24,25]},"content":"La métrique de BGP est de type &quot;distance-vector&quot; et correspond au nombre d'&quot;AS&quot; traversés. L'attribut de chemins &quot;AS_PATH&quot; qui contient les AS traversés permet (mais il n'est pas le seul critère) à BGP de choisir le meilleur chemin: c'est le plus court &quot;AS-PATH&quot; qui est retenu comme chemin."},{"type":"list_item","depth":2,"payload":{"lines":[25,26]},"content":"BGP dispose d'un mécanisme de prévention des boucles : si un &quot;AS_PATH&quot; contient l'&quot;AS&quot; auquel appartient le routeur ce vecteur est mise de côté lors du choix de la meilleure route."},{"type":"list_item","depth":2,"payload":{"lines":[26,27]},"content":"Il n'y a pas de paquets &quot;Hello&quot; pour l'auto-découverte des &quot;peers&quot; entre eux et donc il est nécessaire de déclarer l'IP du voisin pour communiquer."},{"type":"list_item","depth":2,"payload":{"lines":[27,28]},"content":"Le temps de convergence de BGP est plus long que celui d'un IGP. En contrepartie, il gère des centaines de milliers de routes ce que ne peut faire un IGP."},{"type":"list_item","depth":2,"payload":{"lines":[28,29]},"content":"Le port TCP 179 est utilisé pour les échanges entre routeurs BGP."},{"type":"list_item","depth":2,"payload":{"lines":[29,30]},"content":"Le bit &quot;don't fragment&quot; est activé et est utilisé par le mécanisme de &quot;Path MTU&quot;."},{"type":"list_item","depth":2,"payload":{"lines":[30,31]},"content":"BGP a besoin d'un IGP pour partager les adresses internes à l'AS. Une route par défaut ne suffit pas."},{"type":"list_item","depth":2,"payload":{"lines":[31,32]},"content":"La table BGP est appelée &quot;Loc-RIB table&quot; (faire &quot;show ip bgp&quot;) et est distincte de la RIB (faire &quot;show ip route&quot;). En conséquence,  il faut vérifier les deux tables : si la route exacte n'existe pas dans la &quot;RIB BGP&quot; ne transmettra pas la route à un autre AS"},{"type":"list_item","depth":2,"payload":{"lines":[32,33]},"content":"Les routes apprises dans iBGP sont redistribuées dans eBGP et vice-versa. Mais il n'y a pas de redistribution des routes d'un routeur iBGP vers un routeur iBGP."}]},{"type":"heading","depth":1,"payload":{"lines":[34,35]},"content":"Deux règles pour BGP :","children":[{"type":"list_item","depth":2,"payload":{"lines":[36,37]},"content":"<strong>Principes de synchronisation</strong> : Les routes apprises via iBGP doivent être également dans la table de routage de votre IGP (OSPF,…) avant d’être annoncées à d’autres peers d’AS différents. Cette règle a pour but de ne pas accepter de transit qu'un routeur hors du réseau iBGP ne pourrait pas router conduisant à devenir un &quot;black hole&quot;. Ce mécanisme ralentit la convergence. Les routeurs supportant dans leur immense majorité iBGP, la synchronisation est donc désactivée par défaut chez Cisco."},{"type":"list_item","depth":2,"payload":{"lines":[37,38]},"content":"<strong>Split-Horizon</strong>: une route apprise par une session iBGP n'est jamais transmise à un autre voisin iBGP afin d'éviter les boucles. On est donc obligé de faire du &quot;full-mesh&quot; entre tous les routeurs iBGP afin que ces routeurs iBGP se connaissent."}]},{"type":"heading","depth":1,"payload":{"lines":[41,42]},"content":"Sessions","children":[{"type":"list_item","depth":2,"payload":{"lines":[43,44]},"content":"<strong>eBGP</strong>","children":[{"type":"list_item","depth":3,"payload":{"lines":[44,45]},"content":"C'est une session BGP entre deux routeurs appartenant à des AS différents."},{"type":"list_item","depth":3,"payload":{"lines":[45,46]},"content":"Le TTL du paquet BGP est de 1 (le routeur averti doit être en frontal du nôtre et donc à une distance de 1 suffit et sécurise les échanges)"},{"type":"list_item","depth":3,"payload":{"lines":[46,47]},"content":"Le routeur averti vérifie que son AS n'est pas dans l'&quot;AS_PATH&quot; reçu."},{"type":"list_item","depth":3,"payload":{"lines":[47,48]},"content":"Le routeur averti positionne le &quot;NEXT-HOP&quot; pour cette AS à l'IP source du routeur source établissant la connexion."},{"type":"list_item","depth":3,"payload":{"lines":[48,49]},"content":"Le routeur averti ajoute son ASN dans l'&quot;AS_PATH&quot;."},{"type":"list_item","depth":3,"payload":{"lines":[49,50]},"content":"La distance administrative est de 20 pour BGP."}]},{"type":"list_item","depth":2,"payload":{"lines":[51,52]},"content":"<strong>iBGP</strong>","children":[{"type":"list_item","depth":3,"payload":{"lines":[52,53]},"content":"Il est fait pour communiquer entre routeurs BGP dans un même AS (TTL des paquets à 255)."},{"type":"list_item","depth":3,"payload":{"lines":[53,54]},"content":"L'attribut AS_PATH n'est pas modifié par iBGP, il n'y a donc pas de détection possible des boucles avec iBGP."},{"type":"list_item","depth":3,"payload":{"lines":[54,56]},"content":"Dans le cas d'un AS de transit les routeurs traversés qui n'implémentent qu'un IGP ne connaissent<br>\npas les routes issues de BGP. Il faut donc soit des routes statiques, soit du &quot;tunelling&quot; MPLS, soit du fullmesh iBGP (&quot;route reflector&quot;), soit redistribuer les routes BGP dans l'IGP mais ...","children":[{"type":"list_item","depth":4,"payload":{"lines":[56,57]},"content":"Il n'est pas conseiller de redistribuer les routes BGP dans l'IGP : il peut y avoir beaucoup de routes BGP...trop pour un IGP qui n'est pas taillé pour cela. Il n'y a pas non plus d'équivalence des métriques IGP ni de traductions possibles des attributs BGP dans le &quot;langage&quot; de l'IGP."},{"type":"list_item","depth":4,"payload":{"lines":[57,58]},"content":"La redistribution des routes de l'IGP dans BGP n'est pas souhaitable non plus : il vaut mieux que tous les routeurs internes à l'AS supportent iBGP avec une topologie &quot;full mesh&quot; qui peut être facilitée par un &quot;RR&quot; (réflecteur de route)."}]},{"type":"list_item","depth":3,"payload":{"lines":[58,59]},"content":"L'attribut &quot;NEXT_HOP&quot; reçu lors de l'échange BGP indique quel est la prochaine IP pour atteindre un réseau. L'attribut &quot;NEXT_HOP&quot; n'est pas mis à jour lors sa transmission via iBGP à un routeur. Ce dernier se retrouve avec un &quot;NEXT_HOP&quot; qui est celui du peer BGP du premier routeur et il lui faut donc un chemin pour le joindre :","children":[{"type":"list_item","depth":4,"payload":{"lines":[59,60]},"content":"Soit en injectant ce &quot;NEXT_HOP&quot;  dans l'IGP de l'AS (déclaration Network dans le routeur eBGP de bordure de notre AS)."},{"type":"list_item","depth":4,"payload":{"lines":[60,61]},"content":"Soit en utilisant la commande &quot;next-hop-self&quot; qui permet de modifier le &quot;NEXT_HOP&quot; avec l'adresse du routeur."}]},{"type":"list_item","depth":3,"payload":{"lines":[61,62]},"content":"La distance administrative de iBGP est de 200."}]}]},{"type":"heading","depth":1,"payload":{"lines":[63,64]},"content":"MP-BGP (multiprotocol BGP)","children":[{"type":"list_item","depth":2,"payload":{"lines":[65,67]},"content":"Protocole BGP permet de travailler avec plusieurs familles et sous familles IP.<br>\nLes notions d'&quot;Address Family Identifier&quot; (<strong>AFI</strong>) et de &quot;Subsequent Address Family Identifier&quot; (<strong>SAFI</strong>) correspondent au format des préfixes transportés:","children":[{"type":"list_item","depth":3,"payload":{"lines":[67,68]},"content":"Les adresses IPv4 sont identifiées en AFI =&gt; IPv4 (1) et SAFI = unicast ou multicast (1)."},{"type":"list_item","depth":3,"payload":{"lines":[68,69]},"content":"Les adresses IPv6 sont identifiées en AFI =&gt; IPv4 (2) et SAFI = unicast ou multicast (1)."},{"type":"list_item","depth":3,"payload":{"lines":[69,70]},"content":"Les adresses VPN IPv4 sont identifiées en AFI = IPv4 (1), SAFI = VPN (128). Une des particularités des routes VPN est d'avoir un label associé."}]},{"type":"list_item","depth":2,"payload":{"lines":[70,71]},"content":"On utilise l'attribut &quot;Path Attributes NLRI&quot; afin de transporter ces informations."}]},{"type":"heading","depth":1,"payload":{"lines":[72,73]},"content":"AS Number (<strong>ASN</strong>)","children":[{"type":"list_item","depth":2,"payload":{"lines":[74,75]},"content":"privés: 64512-65535"},{"type":"list_item","depth":2,"payload":{"lines":[75,76]},"content":"publics: le reste ... les ASN sont assignés par le &quot;IANA&quot;"}]},{"type":"heading","depth":1,"payload":{"lines":[77,78]},"content":"Messages BGP échangés sur le port tcp 179","children":[{"type":"list_item","depth":2,"payload":{"lines":[79,80]},"content":"OPEN (établissement de l'adjacence)."},{"type":"list_item","depth":2,"payload":{"lines":[80,81]},"content":"UPDATE (échange, retraits de routes)."},{"type":"list_item","depth":2,"payload":{"lines":[81,82]},"content":"NOTIFICATION (message d'erreurs)."},{"type":"list_item","depth":2,"payload":{"lines":[82,83]},"content":"KEEPALIVE (vérification que le &quot;peer&quot; est vivant toutes les 60 secondes, au bout de 180 secondes toutes les routes provenant de ce &quot;peer&quot; seront supprimées)."}]},{"type":"heading","depth":1,"payload":{"lines":[84,85]},"content":"Les différents états de la relation entre deux voisins BGP (&quot;neighbor state&quot;)","children":[{"type":"list_item","depth":2,"payload":{"lines":[86,87]},"content":"Idle (démarrage de la session connexion au voisin)"},{"type":"list_item","depth":2,"payload":{"lines":[87,88]},"content":"Connect (après 3WayHandshake -&gt; reset -&gt; message OPEN envoyé par le routeur)."},{"type":"list_item","depth":2,"payload":{"lines":[88,89]},"content":"Active (l'autre routeur répond par un message Open vers OpenSet)"},{"type":"list_item","depth":2,"payload":{"lines":[89,90]},"content":"OpenSent (sans erreurs migration vers OpenConfirm)"},{"type":"list_item","depth":2,"payload":{"lines":[90,91]},"content":"OpenConfirm (BGP attend des messages KEEPALIVE ou NOTIFICATION)"},{"type":"list_item","depth":2,"payload":{"lines":[91,92]},"content":"Established (échange de routes via le message UPDATE)"}]},{"type":"heading","depth":1,"payload":{"lines":[93,94]},"content":"Intérêt de l'agrégation de préfixes avec BGP","children":[{"type":"list_item","depth":2,"payload":{"lines":[95,96]},"content":"Afin de réduire la taille des tables de routages."},{"type":"list_item","depth":2,"payload":{"lines":[96,97]},"content":"Améliorer la stabilité en cachant les &quot;route flaps&quot;."}]},{"type":"heading","depth":1,"payload":{"lines":[98,99]},"content":"RFC","children":[{"type":"list_item","depth":2,"payload":{"lines":[100,101]},"content":"RFC 1105 juin 1989."},{"type":"list_item","depth":2,"payload":{"lines":[101,102]},"content":"RFC 1654 juillet 1994."},{"type":"list_item","depth":2,"payload":{"lines":[102,103]},"content":"RFC 2283 février 1998."}]}]},{"colorFreezeLevel":2,"maxWidth":700})</script>
</body>
</html>
