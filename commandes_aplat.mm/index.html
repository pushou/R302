
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.5.7">
    
    
      
        <title>Commandes BGP (texte) - BUT R302 Réseaux d'opérateurs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.20d9efc8.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#commandes-linux-pour-voir-les-as-traversees-et-plus-encore" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="BUT R302 Réseaux d&#39;opérateurs" class="md-header__button md-logo" aria-label="BUT R302 Réseaux d'opérateurs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            BUT R302 Réseaux d'opérateurs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Commandes BGP (texte)
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="BUT R302 Réseaux d&#39;opérateurs" class="md-nav__button md-logo" aria-label="BUT R302 Réseaux d'opérateurs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    BUT R302 Réseaux d'opérateurs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Généralités BGP (mindmap)
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../aplat/" class="md-nav__link">
        Généralités BGP (texte)
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../bgp_cmd.html" class="md-nav__link">
        Commandes BGP (mindmap)
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Commandes BGP (texte)
      </a>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../mplsmm/" class="md-nav__link">
        Généralités MPLS (mindmap)
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../mpls_aplat.mm/" class="md-nav__link">
        Généralités MPLS (texte)
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../mpls_cmd.html" class="md-nav__link">
        Commandes MPLS (mindmap)
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../mpls_cmd_aplat.mm/" class="md-nav__link">
        Commandes MPLS (texte)
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="commandes-linux-pour-voir-les-as-traversees-et-plus-encore">Commandes Linux pour voir les AS traversées et plus encore</h1>
<ul>
<li>mtr</li>
</ul>
<pre><code class="language-bash">  mtr --tcp --port 443 --show-ips --mpls --aslookup --curses www.umontpellier.fr
  mtr -P 443 -T  -b -e -z -t 194.199.227.220
  mtr  -P 443 -T -c 2  -b -e -z -t -j 194.199.227.220 | from json|flatten|get hubs|flatten
</code></pre>
<ul>
<li>traceroute</li>
</ul>
<pre><code class="language-bash">traceroute -A -n -e -i eth0 8.8.8.8
</code></pre>
<h1 id="commandes-cisco">Commandes Cisco</h1>
<h2 id="configuration-bgp-basique">Configuration BGP basique</h2>
<pre><code class="language-ios"># 65100 est l'AS dans lequel est notre routeur
router bgp  65100
    # par défaut on est prévenu des changements sur le voisin
    bgp log-neighbor-changes
    # Commande "synchronisation": un routeur BGP de bordure annonce une route à son peer BGP que si cette route est aussi connue de son IGP.
    # Le but est d'éviter de perdre du trafic dans une AS de transit dans laquelle un routeur qui ne serait pas iBGP deviendrait un trou noir pour le trafic en transit
    # Mais tous les routeurs de nos jours font du iBGP et dialogue entre eux via un "Route Reflector"  ou on utilise des routeurs MPLS qui peuvent transmettre du trafic sans table de routage.   
    # En conséquence la synchronisation est désactivée par défaut sur un Cisco:
    no synchronisation
    # Sans lookpback lors de la sélection du meilleur chemin un critère est le plus haut router-id.
    # Si la loopback est positionné c'est elle qu sert d'id. A défaut c'est l'IP la plus élevée qui sert d'id. le router-id apporte peu de choses. 
    bgp router-id 1.1.1.1 

    # déclaration du voisin BGP et de son AS
    neighbor 10.12.1.1 remote-as 65200
    # Network permet de déclarer les réseaux à annoncer. Contrairement à OSPF cette déclaration n'est pas liée à une interface, c'est juste une déclaration...
    network 192.168.1.0 mask 255.255.255.0
    network 192.168.2.0 mask 255.255.255.0      
    # soft-reconfiguration permet d'accéder aux routes reçues d'un peer BGP
    # avec la commande "sh ip bgp neighbors 1.1.1.1 received-routes"
    neighbor 10.12.1.1 soft-reconfiguration inbound
</code></pre>
<h2 id="configuration-bgp-avec-une-loopback">Configuration BGP avec une LoopBack</h2>
<p>Comme avec le protocoel OSPF annoncer le protocole à un voisin depuis une IP de loopback nous protège d'une panne matérielle et évite de casser la session BGP entre les deux routeurs. </p>
<pre><code class="language-ios"># Notre loopback
interface Loopback2
 ip address 2.2.2.2 255.255.255.255
!
router bgp 65535
   bgp log-neighbor-changes

   # Les routes apprises par iBGP ne sont pas retransmises pas défaut dans l'IGP 
   # La commande suivante permet de le faire.  
   bgp redistribute-internal

   network 11.0.0.0 mask 255.255.255.0
   #
   neighbor 1.1.1.1 remote-as 65531

   # Le TTL des paquets eBGP lors de l'établissement d'une session est de 1.
   # Une LoopBack étant à 2 sauts de l'interface du routeur eBGP le peer supprimera 
   # le paquet avant son arrivée à la LoopBack: on change le TTL des paquets eBGP à 2
   # ce n'est pas nécessaire avec iBGP ou le TTL est de 255.
   neighbor 1.1.1.1 ebgp-multihop 2

   # Une autre façon de faire désactiver le besoin de BGP d'avoir une 
   # connexion directe avec le routeur voisin 
   neighbor 1.1.1.1 disable-connected-check

   # On indique avec update-source au routeur d'utiliser toutes les interfaces
   # opérationnelles pour établir les connexions  BGP TCP avec le peer. 
   # tant que Loopback1 est "up" et est configurée avec une adresse IP

   neighbor 1.1.1.1 update-source Loopback1
   # L'AS number est le même ici que celui de notre routeur. Le "peer" étant dans notre AS on a donc une session iBGP avec ce "peer"
   neighbor 5.5.5.5 remote-as 65535
   neighbor 5.5.5.5 update-source Loopback1

   # Quand une route est transmise à un routeur iBGP
   # le next-hop est un attribut BGP obligatoire
   # En faisant un "lookup" dessus on obtient l'
   # interface de sortie du routeur.
   # Quand une route BGP est transmise d'un routeur eBGP à un
   # routeur iBGP le next_hop reste inchangé et donc le routeur iBGP ne sait pas comment atteindre l'IP de ce NextHop.
   # Le next-hop-self permet que l'IP du routeur source iBGP devienne le next-hop à atteindre 
   neighbor 5.5.5.5 next-hop-self

# Cette route statique obligatoire afin d'atteindre la loopback qui
# est derrière l'interface physique du routeur (Voir la solution IGP ci-dessous)
ip route 1.1.1.1 255.255.255.255 11.0.0.100

</code></pre>
<h2 id="configuration-bgp-avancee">Configuration BGP avancée</h2>
<p>Cisco considère que les peers BGP sont IPv4... ce qui n'est pas forcément vrai.
Il vaut donc mieux l'éviter en activant spécifiquement les protocoles utilisés par chaque voisin.</p>
<pre><code class="language-ios">interface Loopback3
 ip address 3.3.3.3 255.255.255.255
 ip ospf 1 area 0
!
interface FastEthernet0/0
 ip address 10.0.23.1 255.255.255.252
 duplex auto
 speed auto
!
interface FastEthernet0/1
 ip address 35.0.0.2 255.255.255.252
 duplex auto
 speed auto
!
# C'est OSPF qui permet au peer BGP de dialoguer de loopback à loopback 
router ospf 1
 log-adjacency-changes
 passive-interface FastEthernet0/1
 network 3.3.3.3 0.0.0.0 area 0
 network 10.0.23.0 0.0.0.255 area 0
!
router bgp 300
# Plus de peer IPV4 actif par défaut:
 no bgp default ipv4-unicast
 bgp log-neighbor-changes
 neighbor 1.1.1.1 remote-as 300
 neighbor 1.1.1.1 update-source Loopback3
 neighbor 35.0.0.1 remote-as 200
 !
 address-family ipv4
  # activations explicites des "peers"
  neighbor 1.1.1.1 activate
  neighbor 35.0.0.1 activate
  neighbor 1.1.1.1 soft-reconfiguration inbound
  neighbor 35.0.0.1 soft-reconfiguration inbound
  no auto-summary
  no synchronization
  network 35.0.0.0 mask 255.255.255.252
 exit-address-family
</code></pre>
<h2 id="agregation-de-routes">Agrégation de routes</h2>
<p>L'agrégation des routes est un enjeu important pour la rapidité de l'internet.</p>
<ul>
<li>as-set conserve les attributs initiaux des routes vers les réseaux</li>
</ul>
<pre><code class="language-ios">aggregate address 192.168.0.0 255.255.0.0 summary-only 
aggregate address 10.202.0.0 255.255.0.0 as-set summary-only 
</code></pre>
<h2 id="injection-de-la-route-par-defaut">injection de la route par défaut</h2>
<p>On ne peut annoncer une route à un peer BGP seulement si cette route est présente dans la table de routage (RIB). L'astuce est d'annoncer une route statique qui ne sera jamais sélectionnée afin que la route soit présente dans la table de routage et puisse être diffuser par BGP comme ici sur une route par défaut.</p>
<pre><code class="language-ios">router bgp 65535
   network 0.0.0.0

ip default route 0.0.0.0 0.0.0.0 null0
</code></pre>
<pre><code class="language-ios">router bgp 65535
   # oblige la création artificielle de la route et l'injecte dans la RIB BGP, que la 
   # route soit présente ou pas dans la table de routage de l'IGP
   default-information originate
</code></pre>
<pre><code class="language-ios">router bgp 65535
   # idem que précédemment mais on averti qu'un seul routeur BGP 
   neighbor 5.5.5.5 default-information originate
</code></pre>
<pre><code class="language-ios"># pour voir l'injection c'est la table bgp
R1(config)#do sh ip bgp
BGP table version is 23, local router ID is 1.1.1.1
Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, 
              r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, 
              x best-external, a additional-path, c RIB-compressed, 
Origin codes: i - IGP, e - EGP, ? - incomplete
RPKI validation codes: V valid, I invalid, N Not found

     Network          Next Hop            Metric LocPrf Weight Path
 *&gt;  0.0.0.0          192.168.1.1              0         32768 i
 *&gt;  2.2.2.2/32       10.11.0.2                0         32768 ?
</code></pre>
<h2 id="commandes-de-debug">Commandes de debug:</h2>
<h3 id="running">running</h3>
<pre><code class="language-ios">
sh run | section bgp  
sh run | s bgp
</code></pre>
<h3 id="show-ip-bgp">show ip bgp</h3>
<pre><code class="language-ios">show ip bgp neighbor
show ip bgp neighbors | include BGP

# nécessite "neighbor 5.5.5.5 soft-reconfiguration inbound"
# liste les réseaux reçus du voisin
sh ip bgp neighbors 1.1.1.1 received-routes

# liste les réseaux réellement appris du voisin
sh ip bgp neighbors 1.1.1.1 routes

# liste les réseaux annoncés au voisin
sh ip bgp neighbors 1.1.1.1 advertised-routes

# hard reset ne pas faire en prod 
clear ip bgp *

# soft reset avec l'adresse du voisin
clear ip bgp 192.168.100.1 soft in|out

debug ip tcp transactions
debug ip bgp
debug ip packet
u all # pour arrêter
</code></pre>
<pre><code class="language-ios">show ip bgp ipv4 unicast summary 
...
BGP router identifier 2.2.2.2, local AS number 65535
BGP table version is 7, main routing table version 7
6 network entries using 864 bytes of memory
7 path entries using 560 bytes of memory
3/3 BGP path/bestpath attribute entries using 408 bytes of memory
2 BGP AS-PATH entries using 48 bytes of memory
0 BGP route-map cache entries using 0 bytes of memory
0 BGP filter-list cache entries using 0 bytes of memory
BGP using 1880 total bytes of memory
BGP activity 6/0 prefixes, 7/0 paths, scan interval 60 secs

Neighbor        V           AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd
1.1.1.1         4        65531     108     118        7    0    0 01:43:01        3
5.5.5.5         4        65535     122     120        7    0    0 01:42:46        3
</code></pre>
<h2 id="cinematique-des-updates-bgp-et-avec-les-routes-locales">Cinématique des updates BGP et avec les routes locales</h2>
<ul>
<li>Quand un message BGP UPDATE arrive, l'information est mise dans la table BGP.</li>
<li>L'algorithme BGP cherche le meilleur chemin.</li>
<li>La RIB du routeur est mise à jour et les voisins aussi.</li>
<li>la version de la table est incrémentée pour chaque changement de <strong>meilleur chemin</strong></li>
</ul>
<h1 id="topologie">topologie</h1>
<ul>
<li><a href="../topo-transit.png">topo transit</a></li>
</ul>
<h1 id="nexthop">nexthop</h1>
<ul>
<li><a href="../nexthop-self.png">avant-après_nexthop_self</a></li>
</ul>
<h1 id="utilitaires">Utilitaires</h1>
<ul>
<li>"Looking Glass" :<a href="https://www.cogentco.com/en/looking-glass">https://www.cogentco.com/en/looking-glass</a></li>
<li>"Routing Information Service" :<a href="https://ris-live.ripe.net/">https://ris-live.ripe.net/</a></li>
<li>"Julia Evans Tools to explore BGP": <a href="https://jvns.ca/blog/2021/10/05/tools-to-look-at-bgp-routes/">https://jvns.ca/blog/2021/10/05/tools-to-look-at-bgp-routes/</a></li>
</ul>
<h1 id="biblio">Biblio</h1>
<ul>
<li>Exemples config eBGP/iBGP Cisco: 
    <a href="https://www.cisco.com/c/en/us/support/docs/ip/border-gateway-protocol-bgp/13751-23.html">https://www.cisco.com/c/en/us/support/docs/ip/border-gateway-protocol-bgp/13751-23.html</a></li>
<li>BGP fundamental Cisco: 
    <a href="https://www.ciscopress.com/articles/article.asp?p=2756480&amp;seqNum=7">https://www.ciscopress.com/articles/article.asp?p=2756480&amp;seqNum=7</a></li>
<li>Configure iBGP:
    <a href="https://www.mustbegeek.com/configure-ibgp-in-cisco-ios-router">https://www.mustbegeek.com/configure-ibgp-in-cisco-ios-router</a></li>
<li>Understand the BGP table
    <a href="https://networkingwithfish.com/understanding-the-bgp-table-version-part-1-introduction-to-bgp-table-version/">https://networkingwithfish.com/understanding-the-bgp-table-version-part-1-introduction-to-bgp-table-version/</a>
<a href="https://networkingwithfish.com/understanding-the-bgp-table-version-part-2-bgp-table-version-in-action/">https://networkingwithfish.com/understanding-the-bgp-table-version-part-2-bgp-table-version-in-action/</a>
<a href="https://networkingwithfish.com/understanding-the-bgp-table-version-part-3-bgp-table-version-troubleshooting/">https://networkingwithfish.com/understanding-the-bgp-table-version-part-3-bgp-table-version-troubleshooting/</a></li>
<li>null interface
    <a href="https://www.cisco.com/c/fr_ca/support/docs/ip/ip-routed-protocols/14956-route-to-null-interface.html">https://www.cisco.com/c/fr_ca/support/docs/ip/ip-routed-protocols/14956-route-to-null-interface.html</a></li>
</ul>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../bgp_cmd.html" class="md-footer__link md-footer__link--prev" aria-label="Previous: Commandes BGP (mindmap)" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Commandes BGP (mindmap)
            </div>
          </div>
        </a>
      
      
        
        <a href="../mplsmm/" class="md-footer__link md-footer__link--next" aria-label="Next: Généralités MPLS (mindmap)" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Généralités MPLS (mindmap)
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.8492ddcf.min.js"></script>
      
    
  </body>
</html>