<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.28.0/themes/prism.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.14.3/dist/style.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@6.7.0"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.14.3"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.14.3/dist/index.umd.min.js"></script><script>(r => {
                setTimeout(r);
              })(() => {
  const {
    markmap,
    mm
  } = window;
  const toolbar = new markmap.Toolbar();
  toolbar.attach(mm);
  const el = toolbar.render();
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, root, jsonOptions) => {
        const markmap = getMarkmap();
        window.mm = markmap.Markmap.create('svg#mindmap', (getOptions || markmap.deriveOptions)(jsonOptions), root);
      })(() => window.markmap,null,{"type":"root","depth":0,"content":"","children":[{"type":"heading","depth":1,"payload":{"lines":[1,2]},"content":"Commandes Linux pour voir les AS traversées et plus encore","children":[{"type":"bullet_list","depth":2,"payload":{"lines":[2,3]},"content":"","children":[{"type":"list_item","depth":3,"payload":{"lines":[2,3]},"content":"mtr"}]},{"type":"fence","depth":2,"content":"<pre class=\"language-bash\"><code class=\"language-bash\">  <span class=\"token function\">mtr</span> <span class=\"token parameter variable\">--tcp</span> <span class=\"token parameter variable\">--port</span> <span class=\"token number\">443</span> --show-ips <span class=\"token parameter variable\">--mpls</span> <span class=\"token parameter variable\">--aslookup</span> <span class=\"token parameter variable\">--curses</span> www.umontpellier.fr\n  <span class=\"token function\">mtr</span> <span class=\"token parameter variable\">-P</span> <span class=\"token number\">443</span> <span class=\"token parameter variable\">-T</span>  <span class=\"token parameter variable\">-b</span> <span class=\"token parameter variable\">-e</span> <span class=\"token parameter variable\">-z</span> <span class=\"token parameter variable\">-t</span> <span class=\"token number\">194.199</span>.227.220\n  <span class=\"token function\">mtr</span>  <span class=\"token parameter variable\">-P</span> <span class=\"token number\">443</span> <span class=\"token parameter variable\">-T</span> <span class=\"token parameter variable\">-c</span> <span class=\"token number\">2</span>  <span class=\"token parameter variable\">-b</span> <span class=\"token parameter variable\">-e</span> <span class=\"token parameter variable\">-z</span> <span class=\"token parameter variable\">-t</span> <span class=\"token parameter variable\">-j</span> <span class=\"token number\">194.199</span>.227.220 <span class=\"token operator\">|</span> from json<span class=\"token operator\">|</span>flatten<span class=\"token operator\">|</span>get hubs<span class=\"token operator\">|</span>flatten\n</code></pre>\n"},{"type":"bullet_list","depth":2,"payload":{"lines":[8,9]},"content":"","children":[{"type":"list_item","depth":3,"payload":{"lines":[8,9]},"content":"traceroute"}]},{"type":"fence","depth":2,"content":"<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">traceroute</span> <span class=\"token parameter variable\">-A</span> <span class=\"token parameter variable\">-n</span> <span class=\"token parameter variable\">-e</span> <span class=\"token parameter variable\">-i</span> eth0 <span class=\"token number\">8.8</span>.8.8\n</code></pre>\n"}]},{"type":"heading","depth":1,"payload":{"lines":[13,14]},"content":"Commandes Cisco","children":[{"type":"heading","depth":2,"payload":{"lines":[17,18]},"content":"Configuration BGP basique","children":[{"type":"fence","depth":3,"content":"<pre class=\"language-ios\"><code class=\"language-ios\"># 65100 est l'AS dans lequel est notre routeur\nrouter bgp  65100\n    # par défaut on est prévenu des changements sur le voisin\n    bgp log-neighbor-changes\n    # Commande &quot;synchronisation&quot;: un routeur BGP de bordure annonce une route à son voisin BGP que si cette route est aussi connue de son IGP.\n    # Le but est d'éviter de perdre du trafic dans une AS de transit dans laquelle un routeur qui ne serait pas iBGP deviendrait un trou noir pour le trafic en transit\n    # Mais tous les routeurs de nos jours font du iBGP et dialogue entre eux via un &quot;Route Reflector&quot;  ou on utilise des routeurs MPLS qui peuvent transmettre du trafic sans table de routage.   \n    # En conséquence la synchronisation est désactivée par défaut sur un Cisco:\n    no synchronisation\n    # Sans lookpback lors de la sélection du meilleur chemin un critère est le plus haut router-id.\n    # Si la loopback est positionné c'est elle qu sert d'id. A défaut c'est l'IP la plus élevée qui sert d'id. le router-id apporte peu de choses. \n    bgp router-id 1.1.1.1 \n    \n    # déclaration du voisin BGP et de son AS\n    neighbor 10.12.1.1 remote-as 65200\n    # Network permet de déclarer les réseaux à annoncer. Contrairement à OSPF cette déclaration n'est pas liée à une interface, c'est juste une déclaration...\n    network 192.168.1.0 mask 255.255.255.0\n    network 192.168.2.0 mask 255.255.255.0      \n    # soft-reconfiguration permet d'accéder aux routes reçues d'un voisin BGP\n    # avec la commande &quot;sh ip bgp neighbors 1.1.1.1 received-routes&quot;\n    neighbor 10.12.1.1 soft-reconfiguration inbound\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[41,42]},"content":"Configuration BGP avec une LoopBack","children":[{"type":"fence","depth":3,"content":"<pre class=\"language-ios\"><code class=\"language-ios\"># Notre loopback\ninterface Loopback2\n ip address 2.2.2.2 255.255.255.255\n!\nrouter bgp 65535\n   bgp log-neighbor-changes\n\n   # Les routes apprises par iBGP ne sont pas retransmises pas défaut dans l'IGP \n   # La commande suivante permet de le faire.  \n   bgp redistribute-internal\n\n   network 11.0.0.0 mask 255.255.255.0\n   #\n   neighbor 1.1.1.1 remote-as 65531\n\n   # Le TTL des paquets eBGP lors de l'établissement d'une session est de 1.\n   # Contrairement à ce qu'on peut penser le TTL n'a pas besoin d'être de 2 car il n'est décrémenté qu'en sortie d'un routeur et pas d'une **interface** ! Néanmoins la connexion BGP\n   # ne s'ouvre pas car un routeur Cisco ne peut pas se connecter à une interface dans un autre réseau. la commande suivante lui permet donc de by-passer cette restriction en\n   # permettant de se connecter à un réseau situé après le réseau directement connecté du voisin BGP. Cette commande laisse le TTL à 1.\n\n   neighbor 1.1.1.1 disable-connected-check \n\n   # On peut aussi utiliser la commande suivante qui elle va modifier le TTL à &quot;2&quot; et permettre la connexion bgp. Elle fonctionne avec eBGP et est nécessaire avec iBGP \n   # car dans ce cas on a plusieurs sauts et le TTL est décrémenté.\n\n   neighbor 1.1.1.1 ebgp-multihop 2\n\n \n\n   # On indique avec update-source au routeur d'utiliser toutes les interfaces\n   # opérationnelles pour établir les connexions  BGP TCP avec le voisin. \n   # tant que Loopback1 est &quot;up&quot; et est configurée avec une adresse IP\n   \n   neighbor 1.1.1.1 update-source Loopback1\n   # L'AS number est le même ici que celui de notre routeur. Le &quot;voisin&quot; étant dans notre AS on a donc une session iBGP avec lui.\n   neighbor 5.5.5.5 remote-as 65535\n   neighbor 5.5.5.5 update-source Loopback1\n\n   # Quand une route est transmise à un routeur iBGP\n   # le next-hop est un attribut BGP obligatoire\n   # En faisant un &quot;lookup&quot; dessus on obtient l'\n   # interface de sortie du routeur.\n   # Quand une route BGP est transmise d'un routeur eBGP à un\n   # routeur iBGP le next_hop reste inchangé et donc le routeur iBGP ne sait pas comment atteindre l'IP de ce NextHop.\n   # Le next-hop-self permet que l'IP du routeur source iBGP devienne le next-hop à atteindre \n   neighbor 5.5.5.5 next-hop-self\n\n# Cette route statique obligatoire afin d'atteindre la loopback qui\n# est derrière l'interface physique du routeur (Voir la solution IGP ci-dessous)\nip route 1.1.1.1 255.255.255.255 11.0.0.100\n\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[99,100]},"content":"Configuration BGP avancée","children":[{"type":"fence","depth":3,"content":"<pre class=\"language-ios\"><code class=\"language-ios\">interface Loopback3\n ip address 3.3.3.3 255.255.255.255\n ip ospf 1 area 0\n!\ninterface FastEthernet0/0\n ip address 10.0.23.1 255.255.255.252\n duplex auto\n speed auto\n!\ninterface FastEthernet0/1\n ip address 35.0.0.2 255.255.255.252\n duplex auto\n speed auto\n!\n# C'est OSPF qui permet au voisins BGP de dialoguer de loopback à loopback \nrouter ospf 1\n log-adjacency-changes\n passive-interface FastEthernet0/1\n network 3.3.3.3 0.0.0.0 area 0\n network 10.0.23.0 0.0.0.255 area 0\n!\nrouter bgp 300\n# Un voisin IPV4 n'est plus actif par défaut avec cette commande:\n no bgp default ipv4-unicast\n bgp log-neighbor-changes\n neighbor 1.1.1.1 remote-as 300\n neighbor 1.1.1.1 update-source Loopback3\n neighbor 35.0.0.1 remote-as 200\n !\n address-family ipv4\n  # activations explicites des &quot;voisins&quot;\n  neighbor 1.1.1.1 activate\n  neighbor 35.0.0.1 activate\n  neighbor 1.1.1.1 soft-reconfiguration inbound\n  neighbor 35.0.0.1 soft-reconfiguration inbound\n  no auto-summary\n  no synchronization\n  network 35.0.0.0 mask 255.255.255.252\n exit-address-family\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[145,146]},"content":"Agrégation de routes","children":[{"type":"bullet_list","depth":3,"payload":{"lines":[149,151]},"content":"","children":[{"type":"list_item","depth":4,"payload":{"lines":[149,150]},"content":"as-set conserve les attributs initiaux des routes vers les réseaux"}]},{"type":"fence","depth":3,"content":"<pre class=\"language-ios\"><code class=\"language-ios\">aggregate address 192.168.0.0 255.255.0.0 summary-only \naggregate address 10.202.0.0 255.255.0.0 as-set summary-only \n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[156,157]},"content":"injection de la route par défaut","children":[{"type":"fence","depth":3,"content":"<pre class=\"language-ios\"><code class=\"language-ios\">router bgp 65535\n   network 0.0.0.0\n\nip default route 0.0.0.0 0.0.0.0 null0\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre class=\"language-ios\"><code class=\"language-ios\">router bgp 65535\n   # oblige la création artificielle de la route et l'injecte dans la RIB BGP, que la \n   # route soit présente ou pas dans la table de routage de l'IGP\n   default-information originate\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre class=\"language-ios\"><code class=\"language-ios\">router bgp 65535\n   # idem que précédemment mais on averti qu'un seul routeur BGP \n   neighbor 5.5.5.5 default-information originate\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre class=\"language-ios\"><code class=\"language-ios\"># pour voir l'injection c'est la table bgp\nR1(config)#do sh ip bgp\nBGP table version is 23, local router ID is 1.1.1.1\nStatus codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, \n              r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, \n              x best-external, a additional-path, c RIB-compressed, \nOrigin codes: i - IGP, e - EGP, ? - incomplete\nRPKI validation codes: V valid, I invalid, N Not found\n\n     Network          Next Hop            Metric LocPrf Weight Path\n *&gt;  0.0.0.0          192.168.1.1              0         32768 i\n *&gt;  2.2.2.2/32       10.11.0.2                0         32768 ?\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[198,199]},"content":"Commandes de debug:","children":[{"type":"heading","depth":3,"payload":{"lines":[200,201]},"content":"running","children":[{"type":"fence","depth":4,"content":"<pre class=\"language-ios\"><code class=\"language-ios\">\nsh run | section bgp  \nsh run | s bgp\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[206,207]},"content":"show ip bgp","children":[{"type":"fence","depth":4,"content":"<pre class=\"language-ios\"><code class=\"language-ios\">show ip bgp neighbor\nshow ip bgp neighbors | include BGP\n\n# nécessite &quot;neighbor 5.5.5.5 soft-reconfiguration inbound&quot;\n# liste les réseaux reçus du voisin\nsh ip bgp neighbors 1.1.1.1 received-routes\n\n# liste les réseaux réellement appris du voisin\nsh ip bgp neighbors 1.1.1.1 routes\n\n# liste les réseaux annoncés au voisin\nsh ip bgp neighbors 1.1.1.1 advertised-routes\n\n# Préfixe le plus long\nshow ip bgp longer-prefixes\n\n# hard reset ne pas faire en prod \nclear ip bgp *\n\n# soft reset avec l'adresse du voisin\nclear ip bgp 192.168.100.1 soft in|out\n\ndebug ip tcp transactions\ndebug ip bgp\ndebug ip packet\nu all # pour arrêter\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre class=\"language-ios\"><code class=\"language-ios\">show ip bgp ipv4 unicast summary \n...\nBGP router identifier 2.2.2.2, local AS number 65535\nBGP table version is 7, main routing table version 7\n6 network entries using 864 bytes of memory\n7 path entries using 560 bytes of memory\n3/3 BGP path/bestpath attribute entries using 408 bytes of memory\n2 BGP AS-PATH entries using 48 bytes of memory\n0 BGP route-map cache entries using 0 bytes of memory\n0 BGP filter-list cache entries using 0 bytes of memory\nBGP using 1880 total bytes of memory\nBGP activity 6/0 prefixes, 7/0 paths, scan interval 60 secs\n\nNeighbor        V           AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd\n1.1.1.1         4        65531     108     118        7    0    0 01:43:01        3\n5.5.5.5         4        65535     122     120        7    0    0 01:42:46        3\n</code></pre>\n"}]}]},{"type":"heading","depth":2,"payload":{"lines":[255,256]},"content":"Cinématique des updates BGP et avec les routes locales","children":[{"type":"list_item","depth":3,"payload":{"lines":[257,258]},"content":"Quand un message BGP UPDATE arrive, l'information est mise dans la table BGP."},{"type":"list_item","depth":3,"payload":{"lines":[258,259]},"content":"L'algorithme BGP cherche le meilleur chemin."},{"type":"list_item","depth":3,"payload":{"lines":[259,260]},"content":"La RIB du routeur est mise à jour et les voisins aussi."},{"type":"list_item","depth":3,"payload":{"lines":[260,261]},"content":"la version de la table est incrémentée pour chaque changement de <strong>meilleur chemin</strong>"}]}]},{"type":"heading","depth":1,"payload":{"lines":[263,264]},"content":"topologie","children":[{"type":"list_item","depth":2,"payload":{"lines":[264,265]},"content":"<a href=\"topo-transit.png\">topo transit</a>"}]},{"type":"heading","depth":1,"payload":{"lines":[266,267]},"content":"nexthop","children":[{"type":"list_item","depth":2,"payload":{"lines":[267,268]},"content":"<a href=\"nexthop-self.png\">avant-après_nexthop_self</a>"}]},{"type":"heading","depth":1,"payload":{"lines":[269,270]},"content":"Utilitaires","children":[{"type":"list_item","depth":2,"payload":{"lines":[271,272]},"content":"&quot;Looking Glass&quot; :<a href=\"https://www.cogentco.com/en/looking-glass\">https://www.cogentco.com/en/looking-glass</a>"},{"type":"list_item","depth":2,"payload":{"lines":[272,273]},"content":"&quot;Routing Information Service&quot; :<a href=\"https://ris-live.ripe.net/\">https://ris-live.ripe.net/</a>"},{"type":"list_item","depth":2,"payload":{"lines":[273,274]},"content":"&quot;Julia Evans Tools to explore BGP&quot;: <a href=\"https://jvns.ca/blog/2021/10/05/tools-to-look-at-bgp-routes/\">https://jvns.ca/blog/2021/10/05/tools-to-look-at-bgp-routes/</a>"}]},{"type":"heading","depth":1,"payload":{"lines":[274,275]},"content":"Biblio","children":[{"type":"list_item","depth":2,"payload":{"lines":[275,277]},"content":"Exemples config eBGP/iBGP Cisco:<br>\n<a href=\"https://www.cisco.com/c/en/us/support/docs/ip/border-gateway-protocol-bgp/13751-23.html\">https://www.cisco.com/c/en/us/support/docs/ip/border-gateway-protocol-bgp/13751-23.html</a>"},{"type":"list_item","depth":2,"payload":{"lines":[277,279]},"content":"BGP fundamental Cisco:<br>\n<a href=\"https://www.ciscopress.com/articles/article.asp?p=2756480&amp;seqNum=7\">https://www.ciscopress.com/articles/article.asp?p=2756480&amp;seqNum=7</a>"},{"type":"list_item","depth":2,"payload":{"lines":[279,281]},"content":"Configure iBGP:<br>\n<a href=\"https://www.mustbegeek.com/configure-ibgp-in-cisco-ios-router\">https://www.mustbegeek.com/configure-ibgp-in-cisco-ios-router</a>"},{"type":"list_item","depth":2,"payload":{"lines":[281,285]},"content":"Understand the BGP table<br>\n<a href=\"https://networkingwithfish.com/understanding-the-bgp-table-version-part-1-introduction-to-bgp-table-version/\">https://networkingwithfish.com/understanding-the-bgp-table-version-part-1-introduction-to-bgp-table-version/</a><br>\n<a href=\"https://networkingwithfish.com/understanding-the-bgp-table-version-part-2-bgp-table-version-in-action/\">https://networkingwithfish.com/understanding-the-bgp-table-version-part-2-bgp-table-version-in-action/</a><br>\n<a href=\"https://networkingwithfish.com/understanding-the-bgp-table-version-part-3-bgp-table-version-troubleshooting/\">https://networkingwithfish.com/understanding-the-bgp-table-version-part-3-bgp-table-version-troubleshooting/</a>"},{"type":"list_item","depth":2,"payload":{"lines":[285,287]},"content":"null interface<br>\n<a href=\"https://www.cisco.com/c/fr_ca/support/docs/ip/ip-routed-protocols/14956-route-to-null-interface.html\">https://www.cisco.com/c/fr_ca/support/docs/ip/ip-routed-protocols/14956-route-to-null-interface.html</a>"}]}],"payload":{}},{"colorFreezeLevel":2,"maxWidth":800})</script>
</body>
</html>
